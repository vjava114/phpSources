<?php

	include_once "../_inc/db.php";
	include "../_inc/global.php";

	
	include "../web_class/paging.php";


	if(!$_POST['page']) $page=1;
	else $page = $_POST['page']; 



	/************ 검색기간 입력시 S. **************/
	$min_month = $_POST['min_month'];
	$min_month2 = $_POST['min_month2'];
	if($min_month2) $min_month2 .= '235959';				// between 검색시, (8월1 ~ 8월1 검색) 하면 8월1일자가 검색이 안되는것 해결 


	//echo "<br> min_month:".$min_month;
	//echo "<br> min_month2:".$min_month2;

	if( $min_month || $min_month2 ){
				
		$search = " AND send_date BETWEEN '$min_month' AND '$min_month2' ";
	}
	/************ 검색기간 입력시 E. **************/


	/****** paging S. ********/
	//if(!$page) $page = 1;	//현재 페이지 변수 설정하기
	$page_row = 10;			//한 화면에 나타날 게시물 수
	$page_scale = 10;		//페이지 블록

	$startLimit = ($page-1) * $page_scale;	// limit의 시작값.
	$endLimit = $page_row; 


	$query = "
				SELECT count(*) as cnt from 	(SELECT   COUNT(*) as cnt
				FROM   event_list e
				JOIN send_list s
				ON       e.seq= s.event_seq
				WHERE 1=1
				
					$search

				GROUP BY s.event_seq) as a 				
				
	";
	$result = mysql_query($query);
	$row = mysql_fetch_row($result);

	$total_record = $row[0];
	//총 게시물 수 구하기 끝//



	$paging_str = paging($page, $page_row, $page_scale);
	/****** paging E. ********/


	// 총 게시물 가지고 오기. (출력용) 시작 //	
	$listQuery = "
SELECT e.seq ,
       e.reg_date ,
       e.event_name ,
       s.type ,
       COUNT(IF(s.rtn_msg    ='succ',1,NULL))                                                                                   AS msg_scnt ,
       COUNT(IF(s.rtn_msg    ='fail',1,NULL))                                                                                   AS msg_fcnt ,
       COUNT(IF(s.receive_msg='succ',1,NULL))                                                                                   AS rcv_scnt,
       COUNT(IF(s.receive_msg='fail',1,NULL))                                                                                   AS rcv_fcnt ,
       COUNT(IF(s.rtn_msg    ='succ',1,NULL)) - COUNT(IF(s.receive_msg='succ',1,NULL)) - COUNT(IF(s.receive_msg='fail',1,NULL)) AS rcv_standby,
	   COUNT(*)																													AS tot_cnt
FROM   event_list                                                                                                               AS e
       JOIN send_list                                                                                                           AS s
       ON     e.seq= s.event_seq
WHERE  1 = 1
			    
				   $search
			   
				GROUP BY s.event_seq
				ORDER BY e.seq DESC
				
				LIMIT $startLimit,$endLimit
	";
	$listResult = mysql_query($listQuery);
	// 총 게시물 가지고 오기. (출력용) 끝 //

	//echo "<br>쿼리확인".$listQuery;


?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset= utf-8" />
<title>TOM N TOMS ADMIN</title>
<link rel="stylesheet" type="text/css" href="../css/default.css" />
<link rel="stylesheet" type="text/css" href="../css/admin.css" />
<link rel="stylesheet" type="text/css" href="../css/ui-lightness/jquery-ui-1.9.2.custom.min.css" />	<!-- jquery-ui 기본이미지 -->
<script type="text/javascript" src="../js/jquery-1.8.3.min.js"></script>	
<script type="text/javascript" src="../js/jquery-ui-1.9.2.custom.js"></script>							<!-- datepicker -->

<script type="text/javascript" src="../js/my/my_calendar.js"></script>		<!-- 커스텀 달력 -->
<script type="text/javascript" src="../js/my/my_validation.js"></script>	<!-- 날짜 유효성 검사 -->

<script>
/*
 * 페이지 이동
	 */
	function goPage(curpage) {
		
		var form = document.frm;	
		var page = document.getElementById("page");
		page.value = curpage;
		 
		form.submit();
	}
	</script>




</head>

<body id="main_bg">
<div id="wrap">
	<!-- top -->
	<div id="header">   	
    	<h1><a href="/"><img src="../images/main_logo.png" alt="TOM N TOMS COFFEE" /></a></h1>
		<ul id="gnb">
			<li><a href="/">HOME</a></li>
			<li> l </li>
			<li><a href="#">사이트 바로가기</a></li>
			<li> l </li>
			<li><a href="#">관리자메뉴얼 다운</a></li>
			<li> l </li>
			<li><a href="../member/logout.php">로그아웃</a></li>			
		</ul>
		<ul id="main_menu">
			<li><a href='#'><img src="../images/gnb01.png" alt="메뉴관리" onmouseout="this.src='../images/gnb01.png'"onmouseover="this.src='../images/gnb01_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb02.png" alt="매장관리" onmouseout="this.src='../images/gnb02.png'"onmouseover="this.src='../images/gnb02_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb03.png" alt="회원관리" onmouseout="this.src='../images/gnb03.png'"onmouseover="this.src='../images/gnb03_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb04.png" alt="이벤트관리" onmouseout="this.src='../images/gnb04.png'"onmouseover="this.src='../images/gnb04_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb05.png" alt="게시판관리" onmouseout="this.src='../images/gnb05.png'"onmouseover="this.src='../images/gnb05_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb06.png" alt="통계분석" onmouseout="this.src='../images/gnb06.png'"onmouseover="this.src='../images/gnb06_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb07.png" alt="설정" onmouseout="this.src='../images/gnb07.png'"onmouseover="this.src='../images/gnb07_on.png'"/></a></li>
			<li><a href='#'><img src="../images/gnb08.png" alt="메시지발송" onmouseout="this.src='../images/gnb08.png'"onmouseover="this.src='../images/gnb08_on.png'"/></a></li>
		</ul>
	</div>
    <!-- /top -->
	<div id="container">
    	<!-- side -->
		<div id="snb">
        	<ul>
				<li class="snb_top bg"><p class="title">메시지발송</p></li>
				<li class="snb_menu"><img src="../images/blit_arrow.gif" alt="" />&nbsp;<a href="#">쿠폰관리</a>
					<ul>
						<li><a href="../couponManage/coupons_inquiry.html">쿠폰조회</a></li>
						<li><a href="../couponManage/coupons_reg.html">쿠폰등록</a></li>
					</ul>
				</li>
				<li class="snb_menu"><img src="../images/blit_arrow.gif" alt="" />&nbsp;<a href="#">메시지 관리</a>
					<ul>
						<li><a href="../messageManage/message_send_v1.html">메시지 발송</a></li>
					</ul>
				</li>
				<li class="snb_menu"><img src="../images/blit_arrow.gif" alt="" />&nbsp;<a href="#">메시지 통계 관리</a>
					<ul>
						<li><a class="on" href="#">발송통계</a></li>
<!-- 						<li><a href="sum_statistics.html">정산통계</a></li> -->
					</ul>
				</li>
				<li><img src="../images/snb_bottom.gif" alt="" /></li>
			</ul>
		</div>
        <!-- /side -->
        <!-- main -->
		<form name="frm" id="frm" method="post" action="send_statistics.html" enctype="multipart/form-data">
		<div id="main">
            <div class="gutter">
				<div class="main_title">
					<h2><img src="../images/blit_arrow_green.gif" alt="" />&nbsp;발송통계</h2>
					<p class="path">HOME <span>></span> 메시지발송 <span>></span> 메시지 통계 관리  <span>></span> 발송통계</p>
					<div class="top_info2">
						<label for="min_month" id="datepciker" class="ip_date">기간</label>
						<input type="text" value="<?= $_POST[min_month] ?>" autocomplete="off" style="width:96px" id="min_month" name="min_month" class="input mr5" title="조회하실 최소기간을 선택해주세요." /> -
						<input type="text" value="<?= $_POST[min_month2] ?>" autocomplete="off" style="width:96px" id="min_month2" name="min_month2" class="input mr5" title="조회하실 최대기간을 선택해주세요." />
						<input type ="image" src="../images/btn_inquiry.gif" class="inquiry" alt="조회"/>
					</div>
				</div>
				<div class="section_main">
					<table>
                		<colgroup>
						<col width="42px" />
						<col width="216px" />
						<col width="*" />
						<col width="81px" />
						<col width="83px" />
						<col width="83px" />
						<col width="83px" />
						<col width="83px" />
						<col width="83px" />
						<col width="83px" />
						<col width="123px" />
                    	</colgroup>
						<thead>
						<tr>
							<th scope="col">번호</th>
							<th scope="col" class="alt">발송 일자</th>
							<th scope="col" class="alt">이벤트 명</th>
							<th scope="col" class="alt">종류</th>
							<th scope="col" class="alt">총 건수</th>
							<th scope="col" class="alt">발송 성공</th>
							<th scope="col" class="alt">발송 실패</th>
							<th scope="col" class="alt">수신 확인</th>
							<th scope="col" class="alt">수신 실패</th>
							<th scope="col" class="alt">수신 대기</th>
							<th scope="col" class="alt">Excel Down</th>
						</tr>
						</thead>
						<tbody>
						
						<?
					if ($total_record == 0)
					{
						$paging_str = "조회된 자료가 없습니다.";
					} 
					else 
					{
						while($row = mysql_fetch_array($listResult))
						{
						?>
						<tr>
							<td><?=$row['seq']?></td>
							<td class="alt"><?=$row['reg_date']?></td>
							<td class="alt"><strong class="txt_red"><?=$row['event_name']?></strong></td>
							<td class="alt"><?=$row[type]?></td>
							<td class="alt"><?=$row[tot_cnt]?></td>
							<td class="alt"><?=$row[msg_scnt]?></td>
							<td class="alt"><?=$row[msg_fcnt]?></td>
							<td class="alt"><?=$row[rcv_scnt]?></td>
							<td class="alt"><?=$row[rcv_fcnt]?></td>
							<td class="alt"><?=$row[rcv_standby]?></td>
							<td class="alt"><a href="dataToExcel_send.php?seq=<?= $row['seq'] ?>&event_name=<?= $row['event_name'] ?>"><img src="../images/btn_excel.gif" alt="excel down" /></a></td>
						</tr>
						<?
						}
					}
						?>
							
						
						</tbody>
					</table>
					
					
					
					<!-- 페이징 S. -->
					<div class="section_bottom">
						<p class="page_num">
							<span>
								<?=$paging_str?>
							</span>
						</p>
					</div>		
					<!-- 페이징 E. -->
					
					<!--  현재페이지 정보 보관하기 위한 hidden 값 S. -->
    				<input type="hidden" name="page" id="page" value="<?= $page ?>" />					
					<!--  현재페이지 정보 보관하기 위한 hidden 값 E. -->
					
					
				</div>
        	</div>
		</div>
		</form>
        <!-- /main -->
	</div>
    <!-- /container -->
</div>
<!-- /wrap -->
<div id="footer">
	<address>Copyright ⓒ 2011 TOM N TOMS COFFEE All rights reserved.</address>
</div>
</body>
</html>
